const DEFAULT_TASKS = [
        { title: "Erholung ðŸŒ¿", info: "Pausen sind wichtig! Nimm dir 15 Min. Zeit." },
        { title: "Hospitation ðŸ‘ï¸â€ðŸ—¨ï¸", info: "Beobachte genau: Wie arbeiten die Profis?" }
    ];

    let questState = [];
    let score = 0;
    let clickCount = 0;

    // --- 1. QR-Code Logik mit Update-Signal ---

    function showQRCode() {
        // Wir nehmen die Aufgaben, wie sie GERADE im Lehrer-MenÃ¼ stehen
        const jsonStr = JSON.stringify(questState.map(t => ({ title: t.title, info: t.info })));
        // Sicherer Export mit Umlaut-Schutz
        const data = btoa(unescape(encodeURIComponent(jsonStr)));
        
        // Der Link enthÃ¤lt die Daten im "q"-Parameter
        const link = window.location.origin + window.location.pathname + "?q=" + data;

        const qrDiv = document.getElementById("qrcode");
        qrDiv.innerHTML = ""; 
        new QRCode(qrDiv, {
            text: link,
            width: 200,
            height: 200,
            correctLevel : QRCode.CorrectLevel.L
        });
        document.getElementById('qr-container').style.display = 'block';
    }

    function checkUrlParams() {
        const params = new URLSearchParams(window.location.search);
        const data = params.get('q');
        
        if (data) {
            try {
                // Dekodieren der neuen Aufgaben
                const decoded = JSON.parse(decodeURIComponent(escape(atob(data))));
                
                // DAS UPDATE-SIGNAL: Wir Ã¼berschreiben den alten Speicher sofort
                questState = decoded.map(t => ({ ...t, completed: false }));
                score = 0;
                
                // Sofort im LocalStorage speichern, bevor die Seite "gesÃ¤ubert" wird
                localStorage.setItem('tasks_vfinal_qr', JSON.stringify(questState));
                localStorage.setItem('score_vfinal_qr', "0");

                // URL sÃ¤ubern (Parameter q entfernen)
                window.history.replaceState({}, document.title, window.location.pathname);
                
                alert("âœ… Update erfolgreich: Neue Aufgaben wurden geladen!");
                render();
            } catch (e) { 
                console.error("Update-Fehler:", e); 
                alert("Fehler beim Laden der neuen Aufgaben.");
            }
        }
    }

    // --- 2. Admin / Lehrer-Bereich ---

    function handleHeaderClick() {
        clickCount++;
        if (clickCount >= 5) { toggleAdmin(); clickCount = 0; }
        setTimeout(() => clickCount = 0, 3000);
    }

    function toggleAdmin() {
        const panel = document.getElementById('adminPanel');
        const isOpening = panel.style.display !== 'block';
        panel.style.display = isOpening ? 'block' : 'none';
        if (isOpening) renderAdmin();
    }

    function renderAdmin() {
        const list = document.getElementById('adminTaskList');
        list.innerHTML = '';
        questState.forEach((task, i) => {
            const div = document.createElement('div');
            div.className = 'admin-task-item';
            div.innerHTML = `
                <input type="text" class="admin-input" value="${task.title}" oninput="updateTask(${i}, 'title', this.value)">
                <textarea class="admin-input" oninput="updateTask(${i}, 'info', this.value)">${task.info}</textarea>
                <button onclick="removeTask(${i})" style="color:red; background:none; border:none; cursor:pointer; font-size:0.7rem; width:100%; text-align:right;">ðŸ—‘ Entfernen</button>
            `;
            list.appendChild(div);
        });
    }

    function addAdminTask() { questState.push({ title: "Neue Aufgabe", info: "", completed: false }); renderAdmin(); }
    function removeTask(i) { questState.splice(i, 1); renderAdmin(); }
    function updateTask(i, key, val) { questState[i][key] = val; }

    // --- 3. Kern-Funktionen ---

    function toggleQuest(index) {
        questState[index].completed = !questState[index].completed;
        save();
    }

    function showInfo(index) {
        document.getElementById('modalTitle').innerText = questState[index].title;
        document.getElementById('modalDescription').innerText = questState[index].info;
        document.getElementById('infoModal').style.display = 'flex';
    }

    function closeInfo() { document.getElementById('infoModal').style.display = 'none'; }

    function save() {
        score = questState.filter(t => t.completed).length * 10;
        localStorage.setItem('tasks_vfinal_qr', JSON.stringify(questState));
        localStorage.setItem('score_vfinal_qr', score.toString());
        render();
    }

    function render() {
        const list = document.getElementById('quest-list');
        const scoreEl = document.getElementById('score');
        if (scoreEl) scoreEl.innerText = score;
        
        if (list) {
            list.innerHTML = '';
            questState.forEach((quest, i) => {
                const item = document.createElement('div');
                item.className = `quest-item ${quest.completed ? 'done' : ''}`;
                item.innerHTML = `
                    <button class="info-btn" onclick="showInfo(${i})">ðŸ’¡</button>
                    <div class="quest-content" onclick="toggleQuest(${i})">
                        <span class="quest-text">${quest.title}</span>
                        <div class="check-circle">${quest.completed ? 'âœ”' : ''}</div>
                    </div>`;
                list.appendChild(item);
            });
        }
        
        const mail = document.getElementById('mailLink');
        if (mail) mail.href = `mailto:koenigstiger70@web.de?subject=Fortschritt&body=Ich habe ${score} Sterne erreicht!`;
    }

    function fullReset() {
        if(confirm("MÃ¶chtest du wirklich alle HÃ¤kchen lÃ¶schen?")) {
            questState.forEach(t => t.completed = false);
            save();
        }
    }

    // --- INITIALISIERUNG ---
    // Erst prÃ¼fen wir auf einen neuen QR-Code Link
    checkUrlParams();
    
    // Dann laden wir den Rest (falls nichts via QR-Code kam)
    if (questState.length === 0) {
        questState = JSON.parse(localStorage.getItem('tasks_vfinal_qr')) || DEFAULT_TASKS;
        score = parseInt(localStorage.getItem('score_vfinal_qr')) || 0;
    }
    render();
